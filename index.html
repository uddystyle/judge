<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>検定集計システム</title>
    <link rel="stylesheet" href="/style.css">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <p id="header-main-text">ようこそ</p>
            <div class="info-display">
                <span id="user-info">ログインしていません</span> |
                <span id="session-info">検定未選択</span> |
                <span id="selection-info">選択中: ー</span>
            </div>
        </div>

        <div class="screen active" id="login-screen">
            <div class="instruction">ログイン</div>
            <div class="form-container">
                <input type="email" id="login-email" placeholder="メールアドレス" autocomplete="email">
                <input type="password" id="login-password" placeholder="パスワード" autocomplete="current-password">
                <div class="nav-buttons">
                    <button class="nav-btn primary" onclick="handleLogin()">ログイン</button>
                    <button class="nav-btn" onclick="showScreen('signup-screen')">新規登録はこちら</button>
                </div>
            </div>
        </div>

        <div class="screen" id="signup-screen">
            <div class="instruction">新規アカウント登録</div>
            <div class="form-container">
                <input type="text" id="signup-name" placeholder="氏名" autocomplete="name">
                <input type="email" id="signup-email" placeholder="メールアドレス" autocomplete="email">
                <input type="password" id="signup-password" placeholder="パスワード (6文字以上)" autocomplete="new-password">
                <div class="nav-buttons">
                    <button class="nav-btn primary" onclick="handleSignup()">登録する</button>
                    <button class="nav-btn" onclick="showScreen('login-screen')">ログイン画面に戻る</button>
                </div>
            </div>
        </div>

        <div class="screen" id="dashboard-screen">
            <div class="instruction">検定を選択</div>
            <div class="list-keypad" id="session-list"></div>
            <div class="nav-buttons">
                <button class="nav-btn primary" onclick="showScreen('create-session-screen')">新しい検定を作成</button>
                <button class="nav-btn" onclick="showScreen('join-session-screen')">コードで参加</button>
                <button class="nav-btn" onclick="showAccountScreen()">アカウント設定</button>
                <button class="nav-btn danger" onclick="handleLogout()">ログアウト</button>
            </div>
        </div>

        <div class="screen" id="create-session-screen">
            <div class="instruction">新しい検定を作成</div>
            <div class="form-container">
                <input type="text" id="session-name-input" placeholder="検定名 (例: 2025冬期検定)">
                <div class="nav-buttons">
                    <button class="nav-btn primary" onclick="handleCreateSession()">作成</button>
                    <button class="nav-btn" onclick="showScreen('dashboard-screen')">戻る</button>
                </div>
            </div>
        </div>

        <div class="screen" id="join-session-screen">
            <div class="instruction">参加コードで合流</div>
            <div class="form-container">
                <input type="text" id="join-code-input" placeholder="6桁の参加コード" maxlength="6" style="text-transform: uppercase;">
                <div class="nav-buttons">
                    <button class="nav-btn primary" onclick="handleJoinSession()">参加</button>
                    <button class="nav-btn" onclick="showScreen('dashboard-screen')">戻る</button>
                </div>
            </div>
        </div>

        <div class="screen" id="discipline-screen">
            <div class="instruction">「種別」を選択してください</div>
            <div class="list-keypad" id="discipline-keypad"></div>
            <div class="nav-buttons"><button class="nav-btn" onclick="goBackToDashboard()">検定選択に戻る</button></div>
        </div>

        <div class="screen" id="level-screen">
            <div class="instruction">検定する「級」を選択してください</div>
            <div class="list-keypad" id="level-keypad"></div>
            <div class="nav-buttons"><button class="nav-btn" onclick="goBackToDisciplineSelect()">種別の選択に戻る</button></div>
        </div>

        <div class="screen" id="event-screen">
            <div class="instruction">検定する「種目」を選択してください</div>
            <div class="list-keypad" id="event-keypad"></div>
            <div class="nav-buttons"><button class="nav-btn" onclick="goBackToLevelSelect()">級の選択に戻る</button></div>
        </div>

        <div class="screen" id="score-screen">
            <div class="numeric-display" id="score-display">0</div>
            <div class="numeric-keypad">
                <button class="numeric-key" onclick="inputNumber('7')">7</button><button class="numeric-key" onclick="inputNumber('8')">8</button><button class="numeric-key" onclick="inputNumber('9')">9</button>
                <button class="numeric-key" onclick="inputNumber('4')">4</button><button class="numeric-key" onclick="inputNumber('5')">5</button><button class="numeric-key" onclick="inputNumber('6')">6</button>
                <button class="numeric-key" onclick="inputNumber('1')">1</button><button class="numeric-key" onclick="inputNumber('2')">2</button><button class="numeric-key" onclick="inputNumber('3')">3</button>
                <button class="numeric-key" onclick="inputNumber('0')">0</button><button class="numeric-key spacer"></button>
                <button class="numeric-key clear" onclick="clearInput()">C</button>
                <button class="numeric-key confirm" onclick="confirmScore()">確定</button>
            </div>
            <div class="nav-buttons"><button class="nav-btn" onclick="changeEvent()">種目を変更</button></div>
        </div>

        <div class="screen" id="bib-screen">
            <div class="instruction">得点: <strong id="confirmed-score"></strong>点<br>ゼッケン番号を入力 (1-999番)</div>
            <div class="numeric-display" id="bib-display">0</div>
            <div class="numeric-keypad">
                <button class="numeric-key" onclick="inputBibNumber('7')">7</button><button class="numeric-key" onclick="inputBibNumber('8')">8</button><button class="numeric-key" onclick="inputBibNumber('9')">9</button>
                <button class="numeric-key" onclick="inputBibNumber('4')">4</button><button class="numeric-key" onclick="inputBibNumber('5')">5</button><button class="numeric-key" onclick="inputBibNumber('6')">6</button>
                <button class="numeric-key" onclick="inputBibNumber('1')">1</button><button class="numeric-key" onclick="inputBibNumber('2')">2</button><button class="numeric-key" onclick="inputBibNumber('3')">3</button>
                <button class="numeric-key" onclick="inputBibNumber('0')">0</button><button class="numeric-key spacer"></button>
                <button class="numeric-key clear" onclick="clearBibInput()">C</button>
                <button class="numeric-key confirm" onclick="confirmBib()">確定</button>
            </div>
            <div class="nav-buttons"><button class="nav-btn" onclick="goBack()">得点修正</button></div>
        </div>

        <div class="screen" id="submit-screen">
            <div class="instruction">採点内容の確認</div>
            <div class="status" style="text-align: left; max-width: 320px; margin: 20px auto; padding: 20px;">
                <p style="margin-bottom: 10px;"><strong>ゼッケン番号:</strong> <span id="final-bib"></span>番</p>
                <p><strong>得点:</strong> <span id="final-score"></span>点</p>
            </div>
            <div id="submit-status"></div>
            <div class="nav-buttons">
                <button class="nav-btn" onclick="editEntry()">修正する</button>
                <button class="nav-btn primary" onclick="submitEntry()">送信する</button>
            </div>
        </div>

        <div class="screen" id="complete-screen">
            <div class="instruction">送信完了</div>
            <div class="status">
                データが正常に送信されました<br>
                <strong>ゼッケン<span id="completed-bib"></span>番: <span id="completed-score"></span>点</strong>
            </div>
            <div class="nav-buttons">
                <button class="nav-btn primary" onclick="nextSkier()">次の滑走者</button>
                <button class="nav-btn" id="export-button-complete" onclick="handleExportOrShare()">結果をエクスポート</button>
                <button class="nav-btn" id="share-button-complete" onclick="handleExportOrShare()">結果を共有</button>
            </div>
        </div>
        <div class="screen" id="confirm-screen">
            <div class="instruction" id="confirm-message"></div>
            <div class="nav-buttons">
                <button class="nav-btn primary" onclick="executeConfirm()">はい</button>
                <button class="nav-btn" onclick="cancelConfirm()">いいえ</button>
            </div>
        </div>

        <div class="screen" id="account-screen">
            <div class="instruction">アカウント設定</div>

            <div class="form-container">
                <label for="account-name" style="text-align: left; font-size: 15px; font-weight: 500; margin-bottom: -8px;">氏名</label>
                <input type="text" id="account-name" placeholder="氏名" autocomplete="name">
                <div class="nav-buttons" style="margin-top: 0;">
                    <button class="nav-btn primary" onclick="handleUpdateName()">名前を更新</button>
                </div>
            </div>

            <hr style="width: 100%; border: none; border-top: 1px solid var(--separator-gray); margin: 24px 0;">

            <div class="form-container">
                <label for="account-password" style="text-align: left; font-size: 15px; font-weight: 500; margin-bottom: -8px;">新しいパスワード</label>
                <input type="password" id="account-password" placeholder="新しいパスワード (6文字以上)" autocomplete="new-password">
                <input type="password" id="account-password-confirm" placeholder="新しいパスワード (確認)" autocomplete="new-password">
                <div class="nav-buttons" style="margin-top: 0;">
                    <button class="nav-btn primary" onclick="handleUpdatePassword()">パスワードを更新</button>
                </div>
            </div>

            <div class="nav-buttons">
                <button class="nav-btn" onclick="showScreen('dashboard-screen')">ダッシュボードに戻る</button>
            </div>
        </div>

        <div class="loading-overlay" id="loading-overlay"><div class="loading"></div></div>
    </div>
    <script src="/script.js"></script>
</body>
</html>